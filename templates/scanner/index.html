{% extends "base.html" %}
{% block title %}Scanner â€” Turnstil{% endblock %}

{% block content %}
<h2>Scanner</h2>

{% if error %}
<p style="color:var(--del-color);">âš ï¸ {{ error }}</p>
{% endif %}

{% if is_staff and not active_event %}

{# â”€â”€ STAFF: EVENT SELECTION MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<article>
    <header><h3>Select Event</h3></header>
    <p>Choose the event you are working before scanning begins.</p>

    {% if events %}
    <form method="post" action="{% url 'select-event' %}">
        {% csrf_token %}
        <label for="event_uuid">Event</label>
        <select name="event_uuid" id="event_uuid" required>
            <option value="" disabled selected>â€” Choose event â€”</option>
            {% for event in events %}
            <option value="{{ event.id }}">
                {{ event.name }} ({{ event.start_time|date:"M j" }})
                {% if event.location %} Â· {{ event.location }}{% endif %}
            </option>
            {% endfor %}
        </select>
        <button type="submit">Start Scanning</button>
    </form>
    {% else %}
    <p><small>No upcoming events are assigned to you. Contact an organizer to be added to an event's staff list.</small></p>
    {% endif %}
</article>

{% else %}

{# â”€â”€ STAFF: ACTIVE EVENT BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if is_staff and active_event %}
<article>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div>
            <strong>ğŸ“ {{ active_event.name }}</strong>
            {% if active_event.location %}<small> Â· {{ active_event.location }}</small>{% endif %}
            <small> Â· {{ active_event.start_time|date:"M j, g:i A" }}</small>
        </div>
        <form method="post" action="{% url 'select-event' %}" style="margin:0;">
            {% csrf_token %}
            <button type="submit" class="outline" style="margin:0; padding:.35rem .85rem; font-size:.85rem;">
                Change Event
            </button>
        </form>
    </div>
</article>
{% endif %}

{# â”€â”€ ATTENDEE: DISCOVERY INTRO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if not is_staff %}
<p><small>Scan a Turnstil QR code to view someone's contact card.</small></p>
{% endif %}

{# â”€â”€ SCANNER UI (staff + attendees) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
<div class="grid">
    <div>
        <!-- Mode Toggle: staff only -->
        {% if is_staff %}
        <fieldset role="group">
            <button id="btn-attendance" class="contrast" onclick="setMode('attendance')">
                âœ“ Attendance
            </button>
            <button id="btn-discovery" class="outline" onclick="setMode('discovery')">
                â†— Discovery
            </button>
        </fieldset>
        {% endif %}

        <!-- Camera -->
        <div id="reader"></div>

        <!-- Manual Entry fallback -->
        <details>
            <summary>Manual UUID Entry</summary>
            <div role="group">
                <input type="text" id="manual-uuid" placeholder="Paste UUID here">
                <button onclick="manualScan()">Submit</button>
            </div>
        </details>
    </div>

    <div>
        <!-- Result Display -->
        <div id="result" class="scan-result" style="display:none"></div>

        <!-- Scan History -->
        <article>
            <header><h3>Recent Scans</h3></header>
            <div id="scan-history">
                <p><small>Scans will appear here...</small></p>
            </div>
        </article>
    </div>
</div>

{% endif %}
{% endblock %}

{% block extra_js %}
{% if is_staff and not active_event %}
{# No JS needed on the event selection screen #}
{% else %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
    // â”€â”€ State â”€â”€
    // Staff default to attendance mode when an event is active; attendees always discover.
    let mode = {% if is_staff %}'attendance'{% else %}'discovery'{% endif %};
    {% if is_staff and active_event %}
    const EVENT_UUID = "{{ active_event.id }}";
    {% endif %}
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 2000;
    const scanHistory = [];

    // CSRF token from Django cookie
    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
            c = c.trim();
            if (c.startsWith(name + '=')) return decodeURIComponent(c.substring(name.length + 1));
        }
        return null;
    }
    const csrfToken = getCookie('csrftoken');

    // â”€â”€ Mode Toggle (staff only) â”€â”€
    function setMode(newMode) {
        mode = newMode;
        document.getElementById('btn-attendance').className = mode === 'attendance' ? 'contrast' : 'outline';
        document.getElementById('btn-discovery').className = mode === 'discovery' ? 'contrast' : 'outline';
    }

    // â”€â”€ Result Display â”€â”€
    function showResult(type, message, detail) {
        const el = document.getElementById('result');
        el.className = 'scan-result scan-' + type;
        el.innerHTML = '<strong>' + message + '</strong>' + (detail ? '<br><small>' + detail + '</small>' : '');
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 4000);
    }

    function addToHistory(result, name, time) {
        const el = document.getElementById('scan-history');
        const placeholder = el.querySelector('p');
        if (placeholder && placeholder.innerText.includes('Scans will appear here')) {
            placeholder.remove();
        }
        const icon = result === 'success' ? 'âœ…' : (result === 'duplicate' ? 'ğŸ”' : (result === 'info' ? 'ğŸ‘¤' : 'âŒ'));
        const entry = document.createElement('div');
        entry.innerHTML = '<small>' + icon + ' <strong>' + name + '</strong> â€” ' + time + '</small><hr>';
        el.prepend(entry);
        scanHistory.unshift({ result, name, time });
    }

    // â”€â”€ Check-in API Call (staff attendance mode only) â”€â”€
    async function checkIn(personUuid) {
        try {
            const resp = await fetch('/api/checkin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    person_uuid: personUuid,
                    event_uuid: EVENT_UUID,
                }),
            });

            const data = await resp.json();
            const now = new Date().toLocaleTimeString();

            if (data.status === 'success') {
                showResult('success', 'âœ“ ' + data.data.person_name, 'Checked in at ' + now);
                addToHistory('success', data.data.person_name, now);
            } else {
                showResult('error', data.code || 'Error', data.message);
                addToHistory(data.code === 'DUPLICATE_CHECKIN' ? 'duplicate' : 'error', data.message, now);
            }
        } catch (err) {
            showResult('error', 'Network Error', 'Could not reach server.');
        }
    }

    // â”€â”€ Contact Fetch (discovery mode â€” available to all users) â”€â”€
    async function fetchContact(personUuid) {
        try {
            const resp = await fetch('/api/people/' + personUuid + '/contact', {
                headers: { 'X-CSRFToken': csrfToken },
            });
            const data = await resp.json();
            const now = new Date().toLocaleTimeString();

            if (data.status === 'success') {
                const c = data.data;
                let detail = '';
                if (c.email) detail += 'ğŸ“§ ' + c.email + '<br>';
                if (c.organization) detail += 'ğŸ¢ ' + c.organization + '<br>';
                if (c.phone) detail += 'ğŸ“ ' + c.phone + '<br>';
                showResult('info', 'ğŸ‘¤ ' + c.name, detail || 'No additional info shared.');
                addToHistory('info', c.name, now);
            } else {
                showResult('error', 'Not Found', 'QR code not recognized.');
                addToHistory('error', 'Unknown QR Code', now);
            }
        } catch (err) {
            showResult('error', 'Network Error', 'Could not reach server.');
            addToHistory('error', 'Network Error', new Date().toLocaleTimeString());
        }
    }

    // â”€â”€ QR Scanner â”€â”€
    function onScanSuccess(decodedText) {
        const now = Date.now();
        if (now - lastScanTime < SCAN_COOLDOWN) return;
        lastScanTime = now;

        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
        if (!uuidRegex.test(decodedText)) {
            showResult('error', 'Invalid QR', 'Not a valid Turnstil QR code.');
            return;
        }

        if (mode === 'attendance') {
            checkIn(decodedText);
        } else {
            fetchContact(decodedText);
        }
    }

    function manualScan() {
        const uuid = document.getElementById('manual-uuid').value.trim();
        if (uuid) onScanSuccess(uuid);
    }

    // â”€â”€ Initialize Camera â”€â”€
    const html5QrCode = new Html5Qrcode("reader");

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess
    ).catch(err => {
        document.getElementById('reader').innerHTML =
            '<p>ğŸ“· Camera access denied or not available.<br>' +
            '<small>Use the manual UUID entry below, or grant camera permission.</small></p>';
    });
</script>
{% endif %}
{% endblock %}